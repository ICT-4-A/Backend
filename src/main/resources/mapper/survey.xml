<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.ictedu.movie.survey.SurveyDao">

	<!-- 가장 최신 설문 번호  -->
	<select id="maxSurveyNum" resultType="Long">
   		SELECT MAX(num) FROM survey
	</select>
 
 	<!-- 설문 조회 -->
 	<select id="findBySNUM" parameterType="Long" resultType="surveyresultvo">
 		SELECT s.num AS surveyNum, s.sub AS surveySub,
			s.sdate AS surveyDate, sc.subcode AS subCode, 
			sc.surveytitle AS surveytitle, sc.surveycnt AS surveycnt
		FROM survey s
		JOIN surveycontent sc ON s.num = sc.subcode
        WHERE s.num = #{num}
 	</select>
 	
 	<!-- 설문 목록 -->
 	<select id="getSurveyList" resultType="surveyvo">
	    SELECT num, sdate, sub, snickname
	    FROM survey
	    ORDER BY num DESC
	</select>

	<!--설문 번호 목록 -->
 	<select id="findAllSurveyNums" resultType="long">
	    SELECT DISTINCT s.num
    	FROM survey s
    	ORDER BY s.num DESC
	</select>
	
	<!-- 전체 투표 수 -->
	<select id="totalCount" resultType="int">
	    SELECT COUNT(*) FROM survey
	</select>

	
	<!-- 설문 목록 투표 수 카운트 -->
	<select id="getSurveyListWithVotes" resultType="surveyvo">
	  SELECT s.num, s.sub, NVL(SUM(sc.surveycnt), 0) AS totalVotes
	  FROM survey s
	  LEFT JOIN surveycontent sc ON s.num = sc.subcode
	  GROUP BY s.num, s.sub ORDER BY s.num DESC
	</select>
 
	<insert id="saveSurvey" parameterType="surveyvo">
	     INSERT INTO survey (num, sdate, sub, snickname) 
    VALUES (survey_seq.NEXTVAL, sysdate, #{sub}, #{snickname})
	</insert>
	
	<insert id="saveSurveyContent" parameterType="surveyContentvo">
	    INSERT INTO surveycontent (subcode, surveycnt, surveytitle)
	    VALUES (#{subcode}, #{surveycnt}, #{surveytitle})
	</insert>

	 <insert id="saveSurveyContentList" parameterType="java.util.List">
	 	INSERT ALL
	 	<foreach collection="list" item="item">
	 		INTO surveycontent (subcode, surveycnt, surveytitle)
	 		VALUES (survey_seq.CURRVAL, #{item.surveycnt}, #{item.surveytitle})
	 	</foreach>
	 	SELECT * FROM dual
	 </insert>

	 <update id="incrementSurveyCount">
	  	UPDATE surveycontent
	  	SET surveycnt = surveycnt + 1
	  	WHERE subcode = #{surveyNum} AND surveytitle = #{surveytitle}
	</update>

	<!-- 페이지네이션 -->
	<select id="listPaged" resultType="kr.co.ictedu.movie.vo.SurveyVO" parameterType="kr.co.ictedu.movie.vo.PageVO">
	    SELECT * FROM (
	        SELECT ROWNUM rn, S.* FROM (
	            SELECT * FROM survey ORDER BY num DESC
	        ) S
	    ) WHERE rn BETWEEN #{beginPerPage} AND #{endPerPage}
	</select>
 
 
</mapper>
