<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.ictedu.movie.friend.FriendRequestDao">
  <select id="selectAllExceptMe" resultType="mem">
  SELECT * FROM member WHERE userid != #{userid}
  </select>
  <insert id="sendRequest">
  INSERT INTO friend_request (id, requester_id, receiver_id) VALUES (friend_request_seq.nextVal, #{requester_id}, #{receiver_id})
  </insert>
  <select id="getPending" resultType="frvo">
  SELECT * FROM friend_request WHERE receiver_id = #{userid} AND status = 'pending'
  </select>
  <update id="updateStatus">
  UPDATE friend_request SET status = #{status} WHERE id = #{id}
  </update>
  <select id="getfriends" resultType="mem">
  SELECT m. * FROM friend_request f JOIN member m ON f.requester_id = m.userid
  WHERE f.receiver_id = #{userid} AND f.status = 'accepted'
  UNION
  SELECT m. * FROM friend_request f JOIN member m ON f.receiver_id = m.userid
  WHERE f.requester_id = #{userid} AND f.status = 'accepted'
  </select>
  <select id="getSentRequests" resultType="frvo">
  SELECT * FROM friend_request WHERE requester_id = #{userid}
  </select>
  <select id="checkRequestExists" resultType="int">
  SELECT COUNT(*) FROM friend_request WHERE requester_id = #{requester_id} AND receiver_id = #{receiver_id}
  </select>
  <update id="resendRequest">
		UPDATE friend_request SET status = 'pending', request_date = SYSDATE
		WHERE requester_id = #{requester_id} AND receiver_id = #{receiver_id}
  </update>
</mapper>