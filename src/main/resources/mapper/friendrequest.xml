<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.ictedu.movie.friend.FriendRequestDao">

    <select id="selectAllExceptMe" resultType="mem">
        SELECT * FROM member WHERE MEMBER_NUM != #{member_num, jdbcType=NUMERIC}
    </select>

    <insert id="sendRequest">
        INSERT INTO friend_request (id, requester_id, receiver_id)
        VALUES (friend_request_seq.nextval, #{requester_id, jdbcType=VARCHAR}, #{receiver_id, jdbcType=VARCHAR})
    </insert>

    <select id="getPending" resultType="frvo">
        SELECT * FROM friend_request WHERE receiver_id = #{receiver_id, jdbcType=VARCHAR} AND status = 'pending'
    </select>
    
    <update id="updateStatus">
        UPDATE friend_request SET status = #{status} WHERE id = #{id}
    </update>
    
	<select id="getFriends" resultType="mem">
	    SELECT m.*
	    FROM friend_request f
	    JOIN member m ON f.requester_id = m.nickname
	    WHERE f.receiver_id = #{member_nickname} AND f.status = 'accepted'
	    UNION
	    SELECT m.*
	    FROM friend_request f
	    JOIN member m ON f.receiver_id = m.nickname
	    WHERE f.requester_id = #{member_nickname} AND f.status = 'accepted'
	</select>

    
    <select id="getSentRequests" resultType="frvo">
        SELECT * 
        FROM friend_request 
        WHERE requester_id = #{member_nickname}
        ORDER BY request_date DESC
    </select>
    
    <!-- 이미 요청이 있는지 확인 해서 count로 돌려줌 -->
    <select id="checkRequestExists" resultType="int">
        SELECT COUNT(*) FROM friend_request WHERE requester_id = #{requester_id}
        AND receiver_id = #{receiver_id}
    </select>
    
    <!-- 재요청: 상태만 pending으로 되돌리기 위해서 업데이트 해야함. -->
    <update id="resendRequest">
        UPDATE friend_request SET status = 'pending', request_date = SYSDATE
        WHERE requester_id = #{requester_id} AND receiver_id = #{receiver_id}
    </update>



</mapper>
