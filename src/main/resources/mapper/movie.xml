<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.ictedu.movie.movie.MovieFormDao">

	<insert id="addMovieform" parameterType="mfvo">
	    INSERT INTO MOVIE_FORM (
	        num, movie_id, writer, toge_writer, simple_review, review, rate,
	        created_at, updated_at, deleted_at, hit
	    ) VALUES (
	        Movie_form_seq.NEXTVAL,
	        #{movie_id},
	        #{writer, jdbcType=VARCHAR},
	        #{toge_writer, jdbcType=VARCHAR},
	        #{simple_review, jdbcType=VARCHAR},
	        #{review, jdbcType=VARCHAR},
	        #{rate, jdbcType=NUMERIC},
	        SYSDATE, SYSDATE, SYSDATE,
	        #{hit, jdbcType=NUMERIC}  
	    )      
	</insert>

	<select id="list" resultType="mfvo" parameterType="map">
	    SELECT * FROM (
			SELECT mf.num, mf.movie_id, mf.writer, mf.toge_writer, mf.simple_review, mf.review,
	            mf.rate, mf.hit, mf.created_at, mf.updated_at, mf.deleted_at,
	            m.title, m.poster, m.genre,
	            w.nickname  AS writer_name,
	            tw.nickname AS toge_writer_name,
	            ROW_NUMBER() OVER (ORDER BY mf.created_at DESC) row_num
	        FROM movie_form mf
	        JOIN movie m ON mf.movie_id = m.num
	        
	        JOIN member w ON mf.writer = w.nickname
	        LEFT JOIN member tw ON mf.toge_writer = tw.nickname
	        <if test="searchValue != null and searchValue != ''">
	            <where>
	                m.title LIKE '%' || #{searchValue} || '%'
	            </where>
	        </if>
	    )
	    WHERE row_num BETWEEN #{begin} AND #{end}
	</select>
	
	<!-- 로그인한 사용자의 영화 기록만 불러오기 -->
	<select id="listByWriter" resultType="mfvo">
    SELECT mf.num, mf.movie_id, mf.writer, mf.toge_writer,
           mf.simple_review, mf.review,
           mf.rate, mf.hit,
           mf.created_at, mf.updated_at, mf.deleted_at,
           m.title, m.poster, m.genre
      FROM movie_form mf
      LEFT JOIN movie m ON mf.movie_id = m.num
     WHERE mf.writer = #{writer}
     ORDER BY mf.num DESC
	</select>


	<select id="totalCount" resultType="int" parameterType="map">
	    SELECT COUNT(*)
	    FROM movie_form mf
	    JOIN movie m ON mf.movie_id = m.num
	    <if test="searchValue != null and searchValue != ''">
	        <where>
	            m.title LIKE '%' || #{searchValue} || '%'
	        </where>
	    </if>
	</select>

	<update id="hit" parameterType="int">
		update movie_form set hit=hit+1 where num=#{num}
	</update>

	<select id="detail" parameterType="int" resultType="mfvo">
		SELECT mf.num, mf.movie_id, mf.writer, mf.toge_writer, mf.simple_review, mf.review, mf.rate, mf.hit, mf.created_at, mf.updated_at, mf.deleted_at,
		m.title, m.poster, m.genre,
		w.nickname AS writer_name,
		tw.nickname AS toge_writer_name
		FROM MOVIE_FORM mf
		JOIN MOVIE M ON mf.movie_id = m.NUM
		JOIN MEMBER w ON mf.writer = w.nickname
		LEFT JOIN MEMBER tw ON mf.toge_writer = tw.nickname
		WHERE mf.num = #{num}
	</select>

	<delete id="delete" parameterType="int">
		delete from movie_form where num=#{num}
	</delete>

	<select id="search" resultType="mvo" parameterType="map"> 
		SELECT num,title,DIRECTOR,actor,genre,poster,RELEASE_DATE FROM MOVIE <if
			test="searchType != null and searchValue != null">
			<where>
				<choose>
					<when test="searchType == 1">
						title like '%'|| #{searchValue} ||'%'
					</when>	
					<when test="searchType == 2">
						genre like '%'|| #{searchValue} ||'%'
					</when>
					<when test="searchType == 3">
						director like '%'|| #{searchValue} ||'%'
					</when>
					<when test="searchType == 4">
						actor like '%'|| #{searchValue} ||'%'
					</when>
				</choose>
			</where>
		</if>
	</select>
	
	<select id="movielist" resultType="mvo">
		select num, title, director, actor, genre, poster, release_date,avg_rating from movie
		order by num desc
	</select>
	
	<select id="getMovie" resultType="mvo" parameterType="int">
		SELECT num, title, director, actor, genre, poster, release_date, avg_rating
		FROM movie
		WHERE num = #{num}
	</select>

	<!-- 특정 영화 기록 모두 조회 -->
	<select id="listByMovie" resultType="mfvo" parameterType="int">
	    SELECT mf.num, mf.movie_id, mf.writer, mf.toge_writer, mf.simple_review, mf.review,
	           mf.rate, mf.hit, mf.created_at, mf.updated_at, mf.deleted_at,
	           m.title, m.poster, m.genre
	      FROM movie_form mf
	      JOIN movie m ON mf.movie_id = m.num
	     WHERE mf.movie_id = #{movieId}
	     ORDER BY mf.created_at DESC
	</select>
	
	<!-- ★ 추가: 영화 평균 평점 업데이트 -->
<update id="updateMovieAvgRating" parameterType="mvo">
    UPDATE movie 
    SET avg_rating = #{avg_rating}
    WHERE num = #{num}
</update>



</mapper>